/**
 * Remove all node_modules directories recursively from the given path.
 */

import { readdir } from 'node:fs/promises'
import { join } from 'pathe'
import Bun from 'bun'
import process from 'node:process'

interface ProcessDirOptions {
  silent: boolean
}

async function processDir(path: string, options: ProcessDirOptions) {
  const dirs = await readdir(path, { withFileTypes: true })

  for (const dirent of dirs) {
    if (!dirent.isDirectory()) continue

    const fullpath = join(path, dirent.name)

    if (!dirent.name.startsWith('node_modules')) {
      await processDir(fullpath, options)

      continue
    }

    if (!options.silent)
      console.log(`Removing ${dirent.name} in ${path}`)

    Bun.spawn({
      cmd: ['sh', '-c', `rm -rf ${fullpath}`],
      stdout: options.silent ? 'ignore' : 'inherit',
      stderr: options.silent ? 'ignore' : 'inherit',
    })
  }
}

async function main() {
  const args = Bun.argv ? Bun.argv.slice(2) : process.argv.slice(2)
  const silent = args.includes('--silent') || args.includes('-s')
  const root = args.find(arg => !arg.startsWith('-')) || '.'

  await processDir(root, { silent })
}

void main()
